sudo: false

cache:
  apt: true
  directories:
  - $HOME/.cache/pip
  - $HOME/.ccache
  - $HOME/.pip-cache
dist: trusty
language: python
env:
  TOX_PARALLEL_NO_SPINNER: 1


matrix:
  include:
    - python: '3.5'
      env: TOXENV="py35-linux"


install:
  - pip install tox
  - sudo apt-get install -y gdb


before_script:
  - ulimit -c unlimited -S  # enable core dumps


script: tox -vv


after_failure:
  - pwd
  - COREFILE=$(find . -maxdepth 1 -name "core*" | head -n 1)
  - if [[ -f "$COREFILE" ]]; then EXECFILE=$(gdb -c "$COREFILE" -batch | grep "Core was generated" | tr -d "\`" | cut -d' ' -f5); file "$COREFILE"; gdb -c "$COREFILE" "$EXECFILE" -x continuous_integration/debug.gdb -batch; fi
